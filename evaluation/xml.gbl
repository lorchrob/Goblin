// Synthesized attributes must be defined in all cases for a given LHS NT
// Inherited attributes for a given LHS NT must be passed by all references to that NT

<xml-tree> ::= <xml-openclose-tag>
             {  <xml-openclose-tag>.<_defs_down> = set.empty<String> ; }
             | <rec-xml-tree> 
            {  <rec-xml-tree>.<_defs_down> = set.empty<String> ; } ;

<rec-xml-tree> ::= <_defs_down> <_defs_up> <xml-openclose-tag> 
                 { <xml-openclose-tag>.<_defs_down> = <_defs_down> ; 
                   <_defs_up> = <xml-openclose-tag>.<_defs_up> ; }  
                 | <_defs_down> <_defs_up> <xml-open-tag> <inner-xml-tree> <xml-close-tag> 
                 // constraint: matching tags
                 { <xml-open-tag>.<id>.<_full_id> = <xml-close-tag>.<id>.<_full_id>; 
                   <_defs_up> = <xml-open-tag>.<_defs_up> ; 
                   <inner-xml-tree>.<_defs_down> = union(<_defs_up>, <_defs_down>) ; 
                   <xml-open-tag>.<_defs_down> = union(<_defs_up>, <_defs_down>) ;
                   <xml-close-tag>.<_defs_down> = union(<_defs_up>, <_defs_down>) ; } ;

<inner-xml-tree> ::= <_defs_down> <text>  
                   |  <_defs_down> <rec-xml-tree> 
                   {  <rec-xml-tree>.<_defs_down> = <_defs_down> ; } 
                   |  <_defs_down> <inner-xml-tree> <inner-xml-tree> 
                  {   <inner-xml-tree>.<_defs_down> = <_defs_down>; } ;

<xml-open-tag> ::= 
                   <_defs_down> <_defs_up> <id>
                 { <_defs_up> = set.empty<String> ; 
                   <id>.<_defs_down> = <_defs_down> ; }
                 | 
                   <_defs_down> <_defs_up> <id> <xml-attribute> 
                 { <_defs_up> = <xml-attribute>.<_defs_up> ; 
                   <id>.<_defs_down> = <_defs_down> ;
                   <xml-attribute>.<_defs_down> = <_defs_down> ; } ;

<xml-close-tag> ::= <_defs_down> <id> { <id>.<_defs_down> = <_defs_down> ; };

<xml-openclose-tag> ::= 
                        <_defs_down> <_defs_up> <id> 
                      { <_defs_up> = set.empty<String> ;
                        <id>.<_defs_down> = <_defs_down> ; } 
                      | 
                        <_defs_down> <_defs_up> <id> <xml-attribute>  
                      { <_defs_up> = <xml-attribute>.<_defs_up> ; 
                        <id>.<_defs_down> = <_defs_down> ; 
                        <xml-attribute>.<_defs_down> = <_defs_down> ; } ;

<xml-attribute> ::= <_defs_down> <_defs_up> <_attributes> <id> <text> 
                  { <_attributes> = set.singleton(<id>.<_full_id>) ; 
                    <id>.<id-with-prefix>.<id-no-prefix-1> = "xmlns" =>
                      <_defs_up> = set.singleton(<id>.<id-with-prefix>.<id-no-prefix-2>) ;
                    not (<id>.<id-with-prefix>.<id-no-prefix-1> = "xmlns") =>
                      <_defs_up> = set.empty<String> ;
                    <id>.<id-no-prefix-1> = <id>.<id-no-prefix-1> => 
                      <_defs_up> = set.empty<String> ; 
                    <id>.<_defs_down> = <_defs_down> ; } 
                  | <_defs_down> <_defs_up> <_attributes> <xml-attribute-1> <xml-attribute-2> 
                    { <_attributes> = union(<xml-attribute-1>.<xml-attribute>.<_attributes>, 
                                            <xml-attribute-2>.<xml-attribute>.<_attributes>) ; 
                      // constraint: no redef
                      set.inter(<xml-attribute-1>.<xml-attribute>.<_attributes>, 
                                <xml-attribute-2>.<xml-attribute>.<_attributes>) = set.empty<String> ; 
                      <_defs_up> = union (<xml-attribute-1>.<xml-attribute>.<_defs_up>,
                                          <xml-attribute-2>.<xml-attribute>.<_defs_up>) ; 
                      <xml-attribute-1>.<xml-attribute>.<_defs_down> = <_defs_down> ; 
                      <xml-attribute-2>.<xml-attribute>.<_defs_down> = <_defs_down> ; } ;

<xml-attribute-1> ::= <xml-attribute> ; 
<xml-attribute-2> ::= <xml-attribute> ;

<id> ::= <_defs_down> <_full_id> <id-no-prefix-1> 
       { <_full_id> = <id-no-prefix-1> ; } 
       | <_defs_down> <_full_id> <id-with-prefix> 
       { <_full_id> = <id-with-prefix>.<id-no-prefix-1> ++ <id-with-prefix>.<id-no-prefix-2> ; 
         <id-with-prefix>.<_defs_down> = <_defs_down> ; } ;

// <id-no-prefix-1> is prefix def, <id-no-prefix-2> is prefix use
<id-with-prefix> ::= <_defs_down> <id-no-prefix-1> <id-no-prefix-2> 
  //!! constraint: namespace definition before use 
  { set.member(<id-no-prefix-2>,  <_defs_down>) ; } ;

<text> :: String {
str.in_re(<text>,
  re.*(
    re.union(
      re.union(
        re.union(
          re.union(
            re.union(
              re.union(
                re.union(
                  re.union(
                    // re.union(
                      re.union(
                        re.union(
                          re.union(
                            re.range("a", "z"),
                            re.range("A", "Z")
                          ),
                          re.range("0", "9")
                      //  ),
                     //   str.to_re("""")
                      ),
                      str.to_re("'")
                    ),
                    str.to_re(".")
                  ),
                  str.to_re(" ")
                ),
                str.to_re("\t")
              ),
              str.to_re("/")
            ),
            str.to_re("?")
          ),
          str.to_re("-")
        ),
        str.to_re(",")
      ),
      re.union(
        str.to_re("="),
        re.union(
          str.to_re(":"),
          str.to_re("+")
        )
      )
    )
  )
) ; } 

;

<id-no-prefix-1> :: String 
{
str.in_re(<id-no-prefix-1>,
  re.++(
    re.union(
      re.union(
        re.range("a", "z"),
        re.range("A", "Z")
      ),
      str.to_re("_")
    ),
    re.*(
      re.union(
        re.union(
          re.union(
            re.union(
              re.range("a", "z"),
              re.range("A", "Z")
            ),
            re.range("0", "9")
          ),
          str.to_re("_")
        ),
        re.union(
          str.to_re("-"),
          str.to_re(".")
        )
      )
    )
  )
) ;
}
; 
<id-no-prefix-2> :: String
{
str.in_re(<id-no-prefix-2>,
  re.++(
    re.union(
      re.union(
        re.range("a", "z"),
        re.range("A", "Z")
      ),
      str.to_re("_")
    ),
    re.*(
      re.union(
        re.union(
          re.union(
            re.union(
              re.range("a", "z"),
              re.range("A", "Z")
            ),
            re.range("0", "9")
          ),
          str.to_re("_")
        ),
        re.union(
          str.to_re("-"),
          str.to_re(".")
        )
      )
    )
  )
) ;
}
; 


<_full_id> :: String;
<_attributes> :: Set(String);
<_defs_down> :: Set(String);
<_defs_up> :: Set(String);
