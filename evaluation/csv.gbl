<csv-file> ::= <_num_cols> <csv-header> <csv-records> 
             { <_num_cols> = <csv-header>.<_num_cols> ;
               <csv-records>.<_num_cols> = <_num_cols> ; } ; 

<csv-header> ::= <csv-record> <_num_cols> 
               { <csv-record>.<_count> = <_num_cols> ; 
                 <_num_cols> > 2; } ; 

<csv-records> ::= <_num_cols> <csv-record> <csv-records> 
                { <csv-record>.<_count> = <_num_cols> ; 
                  <csv-records>.<_num_cols> = <_num_cols> ; }
                | <_num_cols> <nil> ; 

<csv-record> ::= <_count> <raw-field> 
               { <_count> = 1; } 
               | <_count> <raw-field> <csv-record> 
               { <_count> = 1 + <csv-record>.<_count> ; } ;


<raw-field> :: String 
{
// simple field 
str_in_re(<raw-field>, 
              re_concat(re_concat(re_star(str_to_re(" ")), 
                    re_union(
                        re_union(re_range("!", "!"), re_range("#", ":")), re_range("<", "~"))), 
                    re_star(str_to_re(" "))))
lor 
// quoted field
str_in_re(<raw-field>,
  re_union(re_union(
    re_range("!", "!"), 
   re_range("#", "~")), 
    re_union(
      re_union(str_to_re("\t"), 
      str_to_re("\n")),
      str_to_re("\r")
    ))
  ) ; 
}
; 

<nil> :: String 
  { <nil> = ""; } ; 

<_count> :: Int ;
<_num_cols> :: Int ;
